// MultiLineLedDisplay.cpp : implementation file
//

#include "stdafx.h"
#include "MultiLineLedDisplay.h"

#ifdef _DEBUG
#define new DEBUG_NEW
#undef THIS_FILE
static char THIS_FILE[] = __FILE__;
#endif

/////////////////////////////////////////////////////////////////////////////
// CMultiLineLedDisplay

CMultiLineLedDisplay::CMultiLineLedDisplay()
{ 
}

CMultiLineLedDisplay::~CMultiLineLedDisplay()
{
}

/////////////////////////////////////////////////////////////////////////////
// CMultiLineLedDisplay message handlers

static LEDCHAR LEDchars[] = {
	
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{'!',0x04,0x04,0x04,0x04,0x00,0x00,0x04},
	{' ',0x0a,0x0a,0x0a,0x00,0x00,0x00,0x00},
	{'#',0x0a,0x0a,0x1f,0x0a,0x1f,0x0a,0x0a},
	{'$',0x04,0x0f,0x14,0x0e,0x01,0x1e,0x04},
	{'%',0x18,0x19,0x02,0x04,0x08,0x13,0x03},
	{'&',0x0c,0x12,0x14,0x08,0x15,0x12,0x0d},
	{0x27,0x18,0x08,0x10,0x0,0x00,0x00,0x00},
	{'(',0x04,0x08,0x10,0x10,0x10,0x08,0x04},
	{')',0x04,0x02,0x01,0x01,0x01,0x02,0x04},
	{'*',0x00,0x04,0x15,0x0e,0x15,0x04,0x00},
	{'+',0x00,0x04,0x04,0x1f,0x04,0x04,0x00},
	{',',0x00,0x00,0x00,0x00,0x06,0x02,0x04},
	{'-',0x00,0x00,0x00,0x1f,0x00,0x00,0x00},
	{'.',0x00,0x00,0x00,0x00,0x00,0x0c,0x0c},
	{'/',0x00,0x01,0x02,0x04,0x08,0x10,0x00},
	{'0',0x0e,0x11,0x13,0x15,0x19,0x11,0x0e},
	{'1',0x04,0x0c,0x04,0x04,0x04,0x04,0x0e},
	{'2',0x0e,0x11,0x01,0x02,0x04,0x08,0x1f},
	{'3',0x1f,0x02,0x04,0x02,0x01,0x11,0x0e},
	{'4',0x02,0x06,0x0a,0x12,0x1f,0x02,0x02},
	{'5',0x1f,0x10,0x1e,0x01,0x01,0x11,0x0e},
	{'6',0x06,0x08,0x10,0x1e,0x11,0x11,0x0e},
	{'7',0x1f,0x01,0x02,0x04,0x08,0x08,0x08},
	{'8',0x0e,0x11,0x11,0x0e,0x11,0x11,0x0e},
	{'9',0x0e,0x11,0x11,0x0f,0x01,0x02,0x0c},
	{':',0x00,0x0c,0x0c,0x00,0x0c,0x0c,0x00},
	{';',0x00,0x0c,0x0c,0x00,0x0c,0x04,0x08},
	{'<',0x01,0x02,0x04,0x08,0x04,0x02,0x01},
	{'=',0x00,0x00,0x1f,0x00,0x1f,0x00,0x00},
	{'>',0x08,0x0c,0x0e,0x0f,0x0e,0x0c,0x08},
	{'?',0x0e,0x11,0x01,0x02,0x04,0x00,0x04},
	{'@',0x0e,0x11,0x01,0x0d,0x15,0x15,0x0e},
	{'A',0x0e,0x11,0x11,0x11,0x1f,0x11,0x11},
	{'B',0x1e,0x11,0x11,0x1e,0x11,0x11,0x1e},
	{'C',0x0e,0x11,0x10,0x10,0x10,0x11,0x0e},
	{'D',0x1c,0x12,0x11,0x11,0x11,0x12,0x1c},
	{'E',0x1f,0x10,0x10,0x1e,0x10,0x10,0x1f},
	{'F',0x1f,0x10,0x10,0x1e,0x10,0x10,0x10},
	{'G',0x0e,0x11,0x10,0x17,0x11,0x11,0x0f},
	{'H',0x11,0x11,0x11,0x1f,0x11,0x11,0x11},
	{'I',0x0e,0x04,0x04,0x04,0x04,0x04,0x0e},
	{'J',0x07,0x02,0x02,0x02,0x02,0x12,0x0c},
	{'K',0x11,0x12,0x14,0x18,0x14,0x12,0x11},
	{'L',0x10,0x10,0x10,0x10,0x10,0x10,0x1f},
	{'M',0x11,0x1b,0x15,0x15,0x11,0x11,0x11},
	{'N',0x11,0x11,0x19,0x15,0x13,0x11,0x11},
	{'0',0x0e,0x11,0x11,0x11,0x11,0x11,0x0e},
	{'P',0x1e,0x11,0x11,0x1e,0x10,0x10,0x10},
	{'Q',0x0e,0x11,0x11,0x11,0x15,0x12,0x0d},
	{'R',0x0e,0x11,0x11,0x1e,0x14,0x12,0x11},
	{'S',0x0f,0x10,0x10,0x0e,0x01,0x01,0x1e},
	{'T',0x1f,0x04,0x04,0x04,0x04,0x04,0x04},
	{'U',0x11,0x11,0x11,0x11,0x11,0x11,0x0e},
	{'V',0x11,0x11,0x11,0x11,0x11,0x0a,0x04},
	{'W',0x11,0x11,0x11,0x15,0x15,0x15,0x0a},
	{'X',0x11,0x11,0x0a,0x04,0x0a,0x11,0x11},
	{'Y',0x11,0x11,0x11,0x0a,0x04,0x04,0x04},
	{'Z',0x1f,0x01,0x02,0x04,0x08,0x10,0x1f},
	{'[',0x0e,0x08,0x08,0x08,0x08,0x08,0x0e},
	{' ',0x11,0x0a,0x1f,0x04,0x1f,0x04,0x04},
	{']',0x0e,0x02,0x02,0x02,0x02,0x02,0x0e},
	{'^',0x04,0x0a,0x11,0x00,0x00,0x00,0x00},
	{'_',0x00,0x00,0x00,0x00,0x00,0x00,0x1f},
	{' ',0x04,0x02,0x01,0x00,0x00,0x00,0x00},
	{'a',0x00,0x00,0x0e,0x01,0x0f,0x11,0x0f},
	{'b',0x10,0x10,0x16,0x19,0x11,0x11,0x1e},
	{'c',0x00,0x00,0x0e,0x10,0x10,0x11,0x0e},
	{'d',0x01,0x01,0x0d,0x13,0x11,0x11,0x0f},
	{'e',0x00,0x00,0x0e,0x11,0x1f,0x10,0x0e},
	{'f',0x06,0x09,0x08,0x1c,0x08,0x08,0x08},
	{'g',0x00,0x0f,0x11,0x11,0x0f,0x01,0x0e},
	{'h',0x10,0x10,0x16,0x19,0x11,0x11,0x11},
	{'i',0x04,0x00,0x0c,0x04,0x04,0x04,0x0e},
	{'j',0x02,0x00,0x06,0x02,0x02,0x12,0x0c},
	{'k',0x10,0x10,0x12,0x14,0x18,0x14,0x12},
	{'l',0x0c,0x04,0x04,0x04,0x04,0x04,0x0e},
	{'m',0x00,0x00,0x1a,0x15,0x15,0x11,0x11},
	{'n',0x00,0x00,0x16,0x19,0x11,0x11,0x11},
	{'o',0x00,0x00,0x0e,0x11,0x11,0x11,0x0e},
	{'p',0x00,0x00,0x1e,0x11,0x1e,0x10,0x10},
	{'q',0x00,0x00,0x0d,0x13,0x0f,0x01,0x01},
	{'r',0x00,0x00,0x16,0x19,0x10,0x10,0x10},
	{'s',0x00,0x00,0x0e,0x10,0x0e,0x01,0x1e},
	{'t',0x08,0x08,0x1c,0x08,0x08,0x09,0x06},
	{'u',0x00,0x00,0x11,0x11,0x11,0x13,0x0d},
	{'v',0x00,0x00,0x11,0x11,0x11,0x0a,0x04},
	{'w',0x00,0x00,0x11,0x11,0x15,0x15,0x0a},
	{'x',0x00,0x00,0x11,0x0a,0x04,0x0a,0x11},
	{'y',0x00,0x00,0x11,0x11,0x0f,0x01,0x0e},
	{'z',0x00,0x00,0x1f,0x02,0x04,0x08,0x1f},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	{' ',0x00,0x00,0x00,0x00,0x00,0x00,0x00},
	
};


int CMultiLineLedDisplay::DrawLedChar( short x, short y, short width, short height, char WhichChar,short red,short green, short blue)
{
	short i,j,xoffset,yoffset, xcurr,ycurr;
	CBrush cBlackBrush,cColorBrush, *oldBrush;
	CPen cPen,cBlackPen, *oldPen;
	char currentBitCode;
	
	int iii=0;
	if (!cBlackBrush.CreateSolidBrush (RGB(0,0,0)))
		iii=1;
	if (!cColorBrush.CreateSolidBrush (RGB(red,green,blue)))
		iii=2; 
	if (!cPen.CreatePen(PS_SOLID,1,RGB(red/1.2,green/1.2,blue/1.2)))
		iii=3;
	if (!cBlackPen.CreatePen(PS_SOLID,1,RGB(0,0,0)))
		iii=4;
	
	
	oldBrush = (CBrush *)mainCDC->SelectObject(&cBlackBrush);
	oldPen =(CPen *)mainCDC->SelectObject(&cBlackPen);
	
	mainCDC->Rectangle(x, y, x+width, y+height);
	
	xoffset = width/7;
	yoffset = height/9;
	xcurr = x;
	ycurr = y;
	
	for(i=0; i< 7; i++)// draw rows
	{
		currentBitCode = LEDchars[WhichChar - 0x20].BitCode[i];
		ycurr += yoffset;
		xcurr = x;
		for(j=0; j<5; j++) // draw columns
		{ 
			if(currentBitCode & 0x10)
			{
				mainCDC->SelectObject(&cPen);
				mainCDC->SelectObject(&cColorBrush);
				
				mainCDC->Rectangle(xcurr, ycurr, xcurr+xoffset, ycurr+yoffset); 
			} 
			currentBitCode = currentBitCode << 1;
			xcurr += xoffset;
		}
	}
	
	mainCDC->SelectObject(oldPen);
	mainCDC->SelectObject(oldBrush);
	
	cBlackBrush.DeleteObject();
	cBlackPen.DeleteObject();
	cColorBrush.DeleteObject();
	cPen.DeleteObject();
	return(0);
}


int CMultiLineLedDisplay::DefineLedDisplay()
{
	CBrush cBrush , grayBrush,*oldBrush;
	CPen cPen, *oldPen;
	
	mainCDC = whichDisplay.mainCWnd->GetDC();
	
	sgNlines = whichDisplay.nLines;
	sgNchars = whichDisplay.nCharsPerLine;
	sgAspect = whichDisplay.AspectRatio;
	sgRed = whichDisplay.Red;
	sgGreen = whichDisplay.Green;
	sgBlue = whichDisplay.Blue;
	sgWidth = whichDisplay.DisplayWidth / whichDisplay.nCharsPerLine ; 
	sgX = whichDisplay.x_offset;
	sgY = whichDisplay.y_offset;
	
	if(sgAspect == 1)
		sgHeight = (9 * sgWidth) / 7 ;
	else 
		sgHeight = whichDisplay.DisplayHeight / whichDisplay.nLines;
	
	grayBrush.CreateSolidBrush (RGB(128,128,128));
	oldBrush = (CBrush *)mainCDC->SelectObject(&grayBrush);
	
	cPen.CreatePen(PS_SOLID,1,RGB(0,0,0));
	oldPen = (CPen *)mainCDC->SelectObject(&cPen);
	
	mainCDC->Rectangle(
		whichDisplay.x_offset-(int)(.05*whichDisplay.DisplayWidth),
		whichDisplay.y_offset-(int)(.05*whichDisplay.DisplayWidth),
		whichDisplay.x_offset+whichDisplay.DisplayWidth+(int)(.05*whichDisplay.DisplayWidth),
		whichDisplay.y_offset+sgHeight*whichDisplay.nLines+(int)(.05*whichDisplay.DisplayWidth)
		);
	
	mainCDC->SelectObject(oldBrush);
	mainCDC->SelectObject(oldPen); 
	cBrush.CreateSolidBrush (RGB(0,0,0));
	oldBrush = (CBrush *)mainCDC->SelectObject(&cBrush);
	
	
	oldPen = (CPen*)mainCDC->SelectObject(&cPen);
	mainCDC->Rectangle(
		whichDisplay.x_offset,
		whichDisplay.y_offset,
		whichDisplay.x_offset+whichDisplay.DisplayWidth,
		whichDisplay.y_offset+sgHeight*whichDisplay.nLines
		);
	
	mainCDC->SelectObject(oldBrush);
	mainCDC->SelectObject(oldPen); 
	
	cBrush.DeleteObject();
	cPen.DeleteObject();
	grayBrush.DeleteObject();
	
	whichDisplay.mainCWnd->ReleaseDC(mainCDC);
	return(0);
}

int CMultiLineLedDisplay::RefreshLedDisplay()
{
	int i,j; 
	int lineOffset; 
	char *CharPtr;
	lineOffset = 0;
	CBrush cBrush, grayBrush, *oldBrush;
	CPen cPen, *oldPen;

	mainCDC = whichDisplay.mainCWnd->GetDC();
	grayBrush.CreateSolidBrush(RGB(128, 128, 128));
	oldBrush = (CBrush *)mainCDC->SelectObject(&grayBrush);

	cPen.CreatePen(PS_SOLID, 1, RGB(0, 0, 0));
	oldPen = (CPen *)mainCDC->SelectObject(&cPen);

	mainCDC->Rectangle(
		whichDisplay.x_offset - (int)(.05*whichDisplay.DisplayWidth),
		whichDisplay.y_offset - (int)(.05*whichDisplay.DisplayWidth),
		whichDisplay.x_offset + whichDisplay.DisplayWidth + (int)(.05*whichDisplay.DisplayWidth),
		whichDisplay.y_offset + sgHeight * whichDisplay.nLines + (int)(.05*whichDisplay.DisplayWidth)
	);

	mainCDC->SelectObject(oldBrush);
	mainCDC->SelectObject(oldPen);
	//cBrush.CreateSolidBrush(RGB(0, 0, 0));
	//oldBrush = (CBrush *)mainCDC->SelectObject(&cBrush);
	/* loop over all lines */
	for(i=0; i< sgNlines; i++)
	{
		CharPtr = whichDisplay.LineStrings[i];
		for(j=0; j < (int)strlen(whichDisplay.LineStrings[i]); j++)
		{
			DrawLedChar( 
				sgX+(j)*sgWidth,
				sgY+lineOffset, 
				sgWidth, 
				sgHeight, 
				*(CharPtr++),
				sgRed,
				sgGreen,
				sgBlue
				);
		}
		
		for(j= strlen(whichDisplay.LineStrings[i]);j<sgNchars; j++)
		{
			DrawLedChar( 
				sgX+(j)*sgWidth,
				sgY+lineOffset, 
				sgWidth, 
				sgHeight, 
				0x20,
				sgRed,
				sgGreen,
				sgBlue
				);
		}
		lineOffset += sgHeight;
	}
	whichDisplay.mainCWnd->ReleaseDC(mainCDC);
	
	return(0);
}

bool CMultiLineLedDisplay::SetLineString(short whichLine, char * whichString)
{ 
	if(whichLine >= whichDisplay.nLines) return (false);
	if((short)strlen(whichString) > (short)whichDisplay.nCharsPerLine) return(false);
	
	strcpy(whichDisplay.LineStrings[whichLine],whichString);
	RefreshLedDisplay();
	
	return (true);
}
;
void CMultiLineLedDisplay::DrawRGB_BarGraph(double Red, double Green, double Blue, BarEncoding whichCode)
{
	
	double dBlueScale, dGreenScale,dRedScale;
	CBrush cBrush , *oldBrush;
	CPen cPen, *oldPen;
	sgNlines = whichDisplay.nLines;
	sgNchars = whichDisplay.nCharsPerLine;
	sgAspect = whichDisplay.AspectRatio;
	sgRed = whichDisplay.Red;
	sgGreen = whichDisplay.Green;
	sgBlue = whichDisplay.Blue;
	sgWidth = whichDisplay.DisplayWidth/whichDisplay.nCharsPerLine ; 
	sgLineWidth = whichDisplay.DisplayWidth/51;
	sgBarWidth = whichDisplay.DisplayWidth;
	if(sgAspect == 1)
		sgHeight = (9 * sgWidth) / 7 ;
	else 
		sgHeight = whichDisplay.DisplayHeight / whichDisplay.nLines;
	
	// calculate scale factors
	
	dBlueScale = Blue/2.0;
	dRedScale = Red/2.0;
	dGreenScale = Green/2.0;
	
	cBrush.CreateSolidBrush (RGB(128,128,128));
	oldBrush = (CBrush *)mainCDC->SelectObject(cBrush);
	
	cPen.CreatePen(PS_SOLID,1,RGB(0,0,0));
	oldPen = (CPen *)mainCDC->SelectObject(cPen);
	mainCDC->Rectangle(
		0+(int)(.05*sgWidth),
		sgHeight*2,
		sgWidth*whichDisplay.nCharsPerLine -(int)(.05*sgWidth),
		sgHeight*3
		);
	
	cBrush.CreateSolidBrush (RGB(128,128,128));
	oldBrush = (CBrush *)mainCDC->SelectObject(cBrush);
	
	cPen.CreatePen(PS_SOLID,1,RGB(0,0,0));
	oldPen = (CPen*)mainCDC->SelectObject(cPen);
	mainCDC->Rectangle(
		0+(int)(.05*sgWidth),
		sgHeight*3,
		sgWidth*whichDisplay.nCharsPerLine -(int)(.05*sgWidth),
		sgHeight*4
		);
	
	cBrush.CreateSolidBrush (RGB(128,128,128));
	oldBrush = (CBrush *)mainCDC->SelectObject(cBrush);
	
	cPen.CreatePen(PS_SOLID,1,RGB(0,0,0));
	oldPen = (CPen*)mainCDC->SelectObject(cPen);
	mainCDC->Rectangle(
		0+(int)(.05*sgWidth),
		sgHeight*4,
		sgWidth*whichDisplay.nCharsPerLine -(int)(.05*sgWidth),
		sgHeight*5
		);
	
	// Draw White Marker
	
	cBrush.CreateSolidBrush (RGB(255,255,255));
	oldBrush = (CBrush *)mainCDC->SelectObject(cBrush);
	
	cPen.CreatePen(PS_SOLID,1,RGB(0,0,0));
	oldPen = (CPen*)mainCDC->SelectObject(cPen);
	mainCDC->Rectangle(
		sgWidth*whichDisplay.nCharsPerLine/2 +(int)(.05*sgWidth),
		sgHeight*2-(int)(.15*sgHeight),
		sgWidth*whichDisplay.nCharsPerLine/2 +(int)(.05*sgWidth+sgLineWidth),
		sgHeight*5+(int)(.15*sgHeight)
		);
	
	// Draw Red Bar
	
	cBrush.CreateSolidBrush (RGB(255,0,0));
	oldBrush = (CBrush *)mainCDC->SelectObject(cBrush);
	
	cPen.CreatePen(PS_SOLID,1,RGB(0,0,0));
	oldPen = (CPen*)mainCDC->SelectObject(cPen);
	mainCDC->Ellipse(
		(int)((dRedScale)*sgBarWidth),
		sgHeight*2,
		(int)((dRedScale)*sgBarWidth+sgLineWidth),
		sgHeight*3
		);
	
	// Draw Green Bar
	
	cBrush.CreateSolidBrush (RGB(0,255,0));
	oldBrush = (CBrush *)mainCDC->SelectObject(cBrush);
	
	cPen.CreatePen(PS_SOLID,1,RGB(0,0,0));
	oldPen = (CPen*)mainCDC->SelectObject(cPen);
	mainCDC->Ellipse(
		(int)((dGreenScale)*sgBarWidth),
		sgHeight*3,
		(int)((dGreenScale)*sgBarWidth+sgLineWidth),
		sgHeight*4
		);
	
	
	// Draw Blue Bar
	
	cBrush.CreateSolidBrush (RGB(0,0,255));
	oldBrush = (CBrush *)mainCDC->SelectObject(cBrush);
	
	cPen.CreatePen(PS_SOLID,1,RGB(0,0,0));
	oldPen = (CPen*)mainCDC->SelectObject(cPen);
	mainCDC->Ellipse(
		(int)((dBlueScale)*sgBarWidth),
		sgHeight*4,
		(int)((dBlueScale)*sgBarWidth+sgLineWidth),
		sgHeight*5
		);
 }